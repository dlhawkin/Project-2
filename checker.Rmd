---
title: "Untitled"
author: "Diahmin Hawkins dlh2166@columbia.edu"
date: "11/9/2024"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      echo = FALSE,
                      fig.align = "center")
```



```{r}
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(MASS)
library(tidyr)
library(kableExtra)
library(knitr)
library(GGally)
library(naniar)
library(visdat)
library(gtsummary)
library(gt)
library(mice)
library(corrplot) 
library(reshape2)
```


```{r}
#Load the data in
project2<- read_csv("project2.csv")
#Observe the data
#head(project2)
dim(project2)

project2%>% vis_dat()
vis_miss(project2)
project2%>% glimpse()
```

```{r}
#Get all the missing data from each column
Missing_Data<- sapply(project2, function(x) sum(is.na(x)))
# Convert to dataframe
Missing_Data_df <- data.frame(ColumnName = names(Missing_Data), `Missing Data` = Missing_Data)

# Set names for the dataframe columns if necessary
names(Missing_Data_df) <- c("Variables", "Missing Data")

# Calculate the total number of rows in the dataset
total_rows <- nrow(project2)  


#Create Missing Data Summary
missing_data_summary <-Missing_Data_df %>%  
  filter(Variables %in% c('ftcd_score', 'inc', 'crv_total_pq1', 'shaps_score_pq1', 
                          'NMR', 'Only.Menthol', 'readiness')) %>%
    mutate(Percent_Missing = (`Missing Data` / total_rows) * 100) %>%
  dplyr::select(Variables, `Missing Data`, Percent_Missing)%>%
  mutate(Variables = case_when(
   Variables == "ftcd_score" ~ "FTCD Score at Baseline",
     Variables == "inc" ~ "Income",
    Variables == "crv_total_pq1" ~ "Cigarette Reward Value at  Baseline",
   Variables == "shaps_score_pq1" ~ "Anhedonia",
    Variables == "NMR" ~ "Nicotine Metabolism Ratio",
    Variables == "Only.Menthol" ~ "Exclusive Mentholated Cigarette User",
    Variables == "readiness" ~ "Baseline Readiness to Quit Smoking"))

# Obtain the total missing data and the percentage or missing data
total_missing <- sum(missing_data_summary$`Missing Data`)
percent_missing_total <- (total_missing / total_rows) * 100

#Create row to combine with the summart table
total_row <- data.frame(
  Variables = "Total",
  `Missing Data` = total_missing,
  Percent_Missing =percent_missing_total
)

#Both data frames have identical column names 
names(total_row) <- names(missing_data_summary)

# Bind the summary table and the total row
missing_data_summary <- rbind(missing_data_summary, total_row)



# Convert to a gtsummary table
missing_data_summary %>%
  gt() %>%
  tab_header(
    title = "Missing Data Summary for Smoking Sessation"
  ) %>%
  cols_label(
    Variables = "Variables",
    `Missing Data` = "Missing Values",
    Percent_Missing = "Percentage Missing (%)"
  ) %>%
  fmt_number(
    columns = vars(Percent_Missing),
    decimals = 2  # Format percentage to two decimal places
  )


```

```{r}
# Compute the correlation matrix using complete observations
cor_matrix <- cor(project2, use = "complete.obs")  # Use complete.obs to ignore NAs

# Melt the correlation matrix for ggplot2
cor_data <- melt(cor_matrix)


#Cessation Smoking correlation plot 
cessation_smoking_plot<-ggplot(data = cor_data, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  scale_fill_gradient2(low = "hotpink", high = "royalblue", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  labs(title = "Correlation of Smoking Cessation",
       x= "Variables",
       y= "Variables") +
  theme_minimal(base_family = "Times") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size= 20))

cessation_smoking_plot
  



```


```{r}
#Change variables into factor and continous variables 
factor_vars <- c("abst","Var","BA","sex_ps", "NHW",
                 "Black", "Hisp", "inc", "edu","ftcd_score",
                 "ftcd.5.mins", "otherdiag", "antidepmed","mde_curr",
                 "Only.Menthol","readiness")

#Mutate variables as factors
project2<- project2%>%
  mutate(across(all_of(factor_vars), as.factor))

chi_square_results <- data.frame(
  Variable1 = character(),
  Variable2 = character(),
  Chi_Square = numeric(),
  Degrees_of_Freedom = numeric(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each unique pair of variables
for (i in 1:(length(factor_vars) - 1)) {
  for (j in (i + 1):length(factor_vars)) {
    var1 <- factor_vars[i]
    var2 <- factor_vars[j]
    
    # Check if both columns exist in the data frame
    if (all(c(var1, var2) %in% colnames(project2))) {
      # Create a contingency table
      table_data <- table(project2[[var1]], project2[[var2]])
      
      # Perform the chi-square test
      chi_test <- chisq.test(table_data)
      
       # Add results to the data frame
      chi_square_results <- rbind(chi_square_results, data.frame(
        Variable1 = var1,
        Variable2 = var2,
        Chi_Square = chi_test$statistic,
        Degrees_of_Freedom = chi_test$parameter,
        P_Value = chi_test$p.value
      ))
    }
  }
}


significance_level <- 0.05

# Filter for significant associations only
significant_results <- chi_square_results %>%
  filter(P_Value < significance_level)


# Display the significant results as a kable table
kable(significant_results, 
      caption = "Significant Chi-Square Test Results", 
      col.names = c("Variable 1", "Variable 2", "Chi-Square", "Degrees of Freedom", "P-Value"),
      digits = 4) # Set digits for p-values and chi-square

```

```{r}
# Find the variables in project2 that are not in factor_vars
continous_vars <- setdiff(names(project2), factor_vars)

project2 <- project2 %>%
  mutate(across(all_of(continous_vars), as.numeric))


# Select only numeric columns for the correlation plot
numeric_data <- project2 %>% select(all_of(continous_vars))

# Calculate the correlation matrix
cor_matrix <- cor(numeric_data, use = "complete.obs")


# Melt the correlation matrix for ggplot2
cor_data2 <- melt(cor_matrix)


#Cessation Smoking correlation plot 
cessation_smoking_plot2<-ggplot(data = cor_data2, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  scale_fill_gradient2(low = "hotpink", high = "royalblue", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  labs(title = "Correlation of Smoking Cessation",
       x= "Variables",
       y= "Variables") +
  theme_minimal(base_family = "Times") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size= 20))

cessation_smoking_plot2
  




```


```{r}
 #Define Treatment Groups
project2 <- project2 %>%
  mutate(treatment_groups = case_when(
    Var == 1 & BA == 1 ~ "BA_VA",
    Var == 0 & BA == 0 ~ "ST_Placebo",
    Var == 0 & BA == 1 ~ "BA_Placebo",
    Var == 1 & BA == 0 ~ "ST_VA"
  ))

# Create demographic/ baseline characeteristcs tabl

demographics_table <- project2 %>%
  group_by(treatment_groups) %>%
  summarise(
     N= n(),
    `Mean Ages` = round(mean(age_ps, na.rm = TRUE), 1),
    `Standard Deviation Ages` = round(sd(age_ps, na.rm = TRUE), 1),
     Sex = round(sum(as.numeric(as.character(sex_ps)), na.rm = TRUE), 1),
    Blacks = round(sum(as.numeric(as.character(Black)), na.rm = TRUE), 1),
    Hispanics = round(sum(as.numeric(as.character(Hisp)), na.rm = TRUE), 1),
    `Non-Hispanic Whites` = round(sum(as.numeric(as.character(NHW)), na.rm = TRUE), 1),
    `Black Percentage` = round(mean(as.numeric(as.character(Black)), na.rm = TRUE) * 100, 1),
    `Hispanic Percentage` = round(mean(as.numeric(as.character(Hisp)), na.rm = TRUE) * 100, 1),
    `Non-Hispanic White Percentage` = round(mean(as.numeric(as.character(NHW)), na.rm = TRUE) * 100, 1),
    `Education Levels`= c(""),
   `Income Levels`= c("") , 
   `Major Depressive Disorder`= c(""),
    `Antidepressant Medication (%)`=round(mean(as.numeric(as.character(antidepmed)), na.rm = TRUE)*100, 1),
    `Other Lifetime Diagnosis`= round(sum(as.numeric(as.character(otherdiag)), na.rm = TRUE), 1),
    `Cigarette Type`= c(""),
   ` Menthol Only` = round(sum(as.numeric(as.character(Only.Menthol)), na.rm = TRUE), 1),
   `Smoking`= c(""),
   `Cigarettes Per Day at Baseline` = round(mean(as.numeric(as.character(cpd_ps)), na.rm = TRUE), 1),
   `Cigarette Reward Value at Baseline`=round(mean(as.numeric(as.character(crv_total_pq1)), na.rm = TRUE), 1),
    `FTCD at Baseline`=round(mean(as.numeric(as.character(ftcd_score)), na.rm = TRUE), 2),
  `Readiness to Quit`=round(mean(as.numeric(as.character(readiness)), na.rm = TRUE), 1),
  `Time to smoking upon waking up`= c(""),
  `Smoking 5 minutes into waking up (%)`=round(mean(as.numeric(as.character(ftcd.5.mins)), na.rm = TRUE)*100, 1),
  
  `Pleasurable Events at Baseline`= c(""),
  `Substitute Reinforcers`= round(mean(as.numeric(hedonsum_n_pq1), na.rm = TRUE), 1),
  `Complimentary Reinforcers`= round(mean(as.numeric(hedonsum_y_pq1), na.rm = TRUE), 1)
    
  )

education_counts <- project2 %>%
  group_by(treatment_groups, edu) %>%
  summarize(Education_Count = n()) %>%
  pivot_wider(names_from = edu, values_from = Education_Count, values_fill = 0)



inc_counts <- project2 %>%
  group_by(treatment_groups, inc) %>%
  summarize(Income_Count = n()) %>%
  pivot_wider(names_from = inc, values_from = Income_Count, values_fill = 0)



mdd_counts <- project2 %>%
  group_by(treatment_groups, mde_curr) %>%
  summarize(MDE_Count = n()) %>%
  pivot_wider(names_from = mde_curr, values_from = MDE_Count, values_fill = 0)

demographics_table <- demographics_table %>%
  left_join(education_counts, by = "treatment_groups") %>%
  left_join(inc_counts, by = "treatment_groups") %>%
  left_join(mdd_counts, by = "treatment_groups")

demographics_table <- demographics_table %>%
  select(treatment_groups, `N`, `Mean Ages`, `Standard Deviation Ages`, Blacks, Hispanics, `Black Percentage`, `Hispanic Percentage`,`Education Levels`, `1.x`,`2.x`,`3.x`,`4.x`,`5.x`, `Income Levels`, `1.y`,`2.y`,`3.y`,`4.y`,`5.y`,`NA`, `Major Depressive Disorder`, `0`,`1`,
         `Cigarette Type`, ` Menthol Only`,  everything())

# Transpose the table
transposed_table <- as.data.frame(t(demographics_table))

# Update column names to reflect the new format
colnames(transposed_table) <- transposed_table[1, ]  # Set the first row as column names
transposed_table <- transposed_table[-1, ]    



#Create Kable Extra Table 
kable(transposed_table, 
      caption = "Demographics Table of the Smoking Cessation Participants",
      col.names = c("Demograhic Characteristics Variable", "BA+Placebo", "BA+VA", "ST+Placebo", "ST+VA"),
      digits =2) # Set digits for p-values and chi-square

```
---
title: "Project2 Report"
author: "Diahmin Hawkins dlh2166@columbia.edu"
date: "11/6/2024"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      echo = FALSE,
                      fig.align = "center")
```


```{r}
#sessionInfo()
#str(project2)

```

```{r}
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(MASS)
library(tidyr)
library(kableExtra)
library(knitr)
library(GGally)
library(naniar)
library(visdat)
library(gtsummary)
library(gt)
library(mice)
library(corrplot) 
library(reshape2)
library(ggwordcloud)
library(magick)
library(glmnet)
install.packages("caret")
library(caret)

```

```{r, eval=FALSE}



# Path to your image
fig_path2 <- "/Users/diahminhawkins/Documents/GitHub/Project2/SmokePicture.png"

# Load the image using magick
img2<- image_read(fig_path2)

# Convert image to raster for use in ggplot
img_raster2<- as.raster(img2)


# Example data
words <- c("Smoking Cessation", "Depression", "MDD", "Readiness", "FTCD", 
           "Menthol", "Antidepressant", "Gender", "Carbon Monoxide", "BDI", 
           "Duration", "Waking up Smoking", "Psychiatric Diagnosis", "Black", "Hispanic","Non-white Hispanic", 
         "Anhedonia","Complimentary Reinforcers", "Substitute Reinforcers",
         "Cigarette Reward", "Varenicline", "Behavioral Activations", "Pharmacotherapy","Psychotherapy")

frequencies <- c(1, 18, 1, 16, 14, 55, 5, 1, 4, 42, 3, 14, 14, 18, 16, 4,7,9,10,22, 55, 36, 40,55)

new_frame <- data.frame(words, frequencies)

# Generate the word cloud on top of the image background
ggplot(new_frame, aes(label = words, size = frequencies)) +
  # Add the image background
  annotation_raster(img_raster2, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  
  # Generate the word cloud
  geom_text_wordcloud(aes(color = frequencies)) +
  scale_size_area(max_size = 10) +
  
  # Customize the colors of the words
  scale_color_gradient(low = "white", high = "black") +
  
  # Remove axis titles and labels since we want the word cloud only
  theme_void()


```


# Introduction 

Mental health disorders are among the most common health conditions associated with tobacco dependence. Studies have shown that smokers with depression find smoking more pleasurable and are more dependent on nicotine, leading to more severe withdrawal symptoms than smokers without major depressive disorder (MDD). Dr. George Papandonatos, from Brown University’s highly regarded Biostatistics Department (ranked #14 in the country by U.S. News & World Report’s Best Graduate Schools), has investigated smoking cessation outcomes in adults diagnosed with MDD.


This study was conducted in research clinics at Northwestern University (Chicago, IL) and the University of Pennsylvania (Philadelphia, PA). Findings from this research indicate that individuals with MDD tend to smoke more heavily, exhibit greater nicotine dependence, and endure more severe withdrawal symptoms than individuals without MDD. According to `Efficacy and Safety of Combination Behavioral Activation for Smoking Cessation and Varenicline for Treating Tobacco Dependence among Individuals with Current or Past Major Depressive Disorder: A 2 × 2 Factorial, Randomized, Placebo-Controlled Trial`, "In conclusion, we found strong evidence that varenicline improved both short- and long-term abstinence rates relative to placebo among racially and socio-economically diverse adults with varied motivation to quit and varied psychiatric presentations" (Hitsman, Papandonatos, et al., 1722). While varenicline has proven effective in supporting smoking cessation, addressing the psychological aspects of smoking behavior, particularly those linked to depression, may further enhance cessation rates among adults with MDD.


The prior study employed a randomized, placebo-controlled, 2x2 factorial design to compare behavioral activation for smoking cessation (BASC) against standard behavioral treatment (ST), with an additional comparison of varenicline versus placebo. This study included 300 adult smokers with either current or past MDD. Findings indicated that BASC did not surpass standard behavioral treatment in effectiveness, regardless of concurrent varenicline therapy.

This current study will focus on three primary aims. The first aim is to assess baseline characteristics as potential moderators of the effects of behavioral treatment on end-of-treatment (EOT) abstinence. The second aim is to investigate whether baseline predictors of abstinence vary depending on the type of behavioral intervention and pharmacotherapy administered. The third aim is to identify which baseline variables (e.g., demographic, psychological, and clinical factors) have the strongest influence on abstinence outcomes. We hypothesize that certain baseline characteristics will significantly interact with treatment type, influencing the likelihood of smoking cessation. interact with treatment type, influencing the likelihood of smoking cessation.



```{r}
#Load the data in
project2<- read_csv("project2.csv")
#Observe the data
#head(project2)
#dim(project2)


#Check for missing data
project2%>% vis_dat()
vis_miss(project2)
project2%>% glimpse()
```




```{r} 
#Get all the missing data from each column
Missing_Data<- sapply(project2, function(x) sum(is.na(x)))
# Convert to dataframe
Missing_Data_df <- data.frame(ColumnName = names(Missing_Data), `Missing Data` = Missing_Data)

# Set names for the dataframe columns if necessary
names(Missing_Data_df) <- c("Variables", "Missing Data")

# Calculate the total number of rows in the dataset
total_rows <- nrow(project2)  


#Create Missing Data Summary
missing_data_summary <-Missing_Data_df %>%  
  filter(Variables %in% c('ftcd_score', 'inc', 'crv_total_pq1', 'shaps_score_pq1', 
                          'NMR', 'Only.Menthol', 'readiness')) %>%
    mutate(Percent_Missing = (`Missing Data` / total_rows) * 100) %>%
  dplyr::select(Variables, `Missing Data`, Percent_Missing)%>%
  mutate(Variables = case_when(
   Variables == "ftcd_score" ~ "FTCD Score at Baseline",
     Variables == "inc" ~ "Income",
    Variables == "crv_total_pq1" ~ "Cigarette Reward Value at  Baseline",
   Variables == "shaps_score_pq1" ~ "Anhedonia",
    Variables == "NMR" ~ "Nicotine Metabolism Ratio",
    Variables == "Only.Menthol" ~ "Exclusive Mentholated Cigarette User",
    Variables == "readiness" ~ "Baseline Readiness to Quit Smoking"))

# Obtain the total missing data and the percentage or missing data
total_missing <- sum(missing_data_summary$`Missing Data`)
percent_missing_total <- (total_missing / total_rows) * 100

#Create row to combine with the summart table
total_row <- data.frame(
  Variables = "Total",
  `Missing Data` = total_missing,
  Percent_Missing =percent_missing_total
)

#Both data frames have identical column names 
names(total_row) <- names(missing_data_summary)

# Bind the summary table and the total row
missing_data_summary <- rbind(missing_data_summary, total_row)



# Convert to a gtsummary table
missing_data_summary %>%
  gt() %>%
  tab_header(
    title = "Missing Data Summary for Smoking Sessation"
  ) %>%
  cols_label(
    Variables = "Variables",
    `Missing Data` = "Missing Values",
    Percent_Missing = "Percentage Missing (%)"
  ) %>%
  fmt_number(
    columns = vars(Percent_Missing),
    decimals = 2  # Format percentage to two decimal places
  )


```

```{r}
# Compute the correlation matrix using complete observations
cor_matrix <- cor(project2, use = "complete.obs")  # Use complete.obs to ignore NAs

# Melt the correlation matrix for ggplot2
cor_data <- melt(cor_matrix)


#Cessation Smoking correlation plot 
cessation_smoking_plot<-ggplot(data = cor_data, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  scale_fill_gradient2(low = "hotpink", high = "royalblue", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  labs(title = "Correlation of Smoking Cessation",
       x= "Variables",
       y= "Variables") +
  theme_minimal(base_family = "Times") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size= 20))

cessation_smoking_plot
  



```


```{r}
#Change variables into factor and continous variables 
factor_vars <- c("abst","Var","BA","sex_ps", "NHW",
                 "Black", "Hisp", "inc", "edu","ftcd_score",
                 "ftcd.5.mins", "otherdiag", "antidepmed","mde_curr",
                 "Only.Menthol","readiness")

#Mutate variables as factors
project2<- project2%>%
  mutate(across(all_of(factor_vars), as.factor))

# Find the variables in project2 that are not in factor_vars
continous_vars <- setdiff(names(project2), factor_vars)

project2 <- project2 %>%
  mutate(across(all_of(continous_vars), as.numeric))

chi_square_results <- data.frame(
  Variable1 = character(),
  Variable2 = character(),
  Chi_Square = numeric(),
  Degrees_of_Freedom = numeric(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each unique pair of variables
for (i in 1:(length(factor_vars) - 1)) {
  for (j in (i + 1):length(factor_vars)) {
    var1 <- factor_vars[i]
    var2 <- factor_vars[j]
    
    # Check if both columns exist in the data frame
    if (all(c(var1, var2) %in% colnames(project2))) {
      # Create a contingency table
      table_data <- table(project2[[var1]], project2[[var2]])
      
      # Perform the chi-square test
      chi_test <- chisq.test(table_data)
      
       # Add results to the data frame
      chi_square_results <- rbind(chi_square_results, data.frame(
        Variable1 = var1,
        Variable2 = var2,
        Chi_Square = chi_test$statistic,
        Degrees_of_Freedom = chi_test$parameter,
        P_Value = chi_test$p.value
      ))
    }
  }
}


significance_level <- 0.05

# Filter for significant associations only
significant_results <- chi_square_results %>%
  filter(P_Value < significance_level)

dim(significant_results)
# Display the significant results as a kable table
kable(significant_results, 
      caption = "Significant Chi-Square Test Results", 
      col.names = c("Variable 1", "Variable 2", "Chi-Square", "Degrees of Freedom", "P-Value"),
      digits = 4) # Set digits for p-values and chi-square


```

```{r}
names(project2)
lm(abst~ abst:Var, abst:NHW, abst:ftcdscore, BA:antidepmed, sex_ps:NHW, 
   sex_ps:Black, sex_ps:readiness, NHW:Black, NHW:Hisp, NHW:inc, family="binary",
   data= project2)

example<- glm(abst ~ (.)^2, 
               family = "binomial", 
               data = complete_data)
 # Display summary of the model
summary(example)

project2$ftc

# Load required library
library(GGally)

# Generate sample data
df <- data.frame(var1 = rnorm(100),
                 var2 = rnorm(100, mean = 1),
                 var3 = rnorm(100, mean = 2))

# Create pair plot
ggpairs(df, title = "Pair Plot of Variables")



plot(project2$abst,as.factor(project2$Black), main = "Scatter Plot of y vs x1",
     xlab = "x1 (Continuous Variable)", ylab = "y (Dependent Variable)", pch = 19, col = "blue")
abline(lm(y ~ x1, data = project2), col = "red") # Add a regression line




```


```{r}

# Select only numeric columns for the correlation plot
numeric_data <- project2 %>% select(all_of(continous_vars))

# Calculate the correlation matrix
cor_matrix <- cor(numeric_data, use = "complete.obs")


# Melt the correlation matrix for ggplot2
cor_data2 <- melt(cor_matrix)


#Cessation Smoking correlation plot 
cessation_smoking_plot2<-ggplot(data = cor_data2, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  scale_fill_gradient2(low = "hotpink", high = "royalblue", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  labs(title = "Correlation of Smoking Cessation",
       x= "Variables",
       y= "Variables") +
  theme_minimal(base_family = "Times") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size= 20))

cessation_smoking_plot2
  


```



```{r}
# str(complete_data)
############# Perform Multiple Imputation ###################

# Perform multiple imputation
imputed_data <- mice(project2, m = 5, method = 'pmm', maxit = 10, seed = 222)

# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data <- complete(imputed_data, 1)


# Assuming your data is called `mydata` and the target variable is `y`
set.seed(222)  # For reproducibility
trainIndex <- createDataPartition(complete_data$abst, p = 0.7, list = FALSE)

# Split the data into training and testing sets
train_data <- complete_data[trainIndex, ]
test_data <- complete_data[-trainIndex, ]





# Complete data model
# complete_data_model1<- lm(abst ~ ., data = complete_data)
# summary(complete_data_model1)
#complete_data
#sum(is.na(complete_data))
```

```{r}
# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data2 <- complete(imputed_data, 2)

# Complete data model
complete_data2_model2<- lm(abst ~ ., data = complete_data2)



```


```{r}
# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data3 <- complete(imputed_data, 3)

# Complete data model
complete_data3_model3<- lm(abst ~ ., data = complete_data3)




```

```{r}
# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data4 <- complete(imputed_data, 4)

# Complete data model
complete_data4_model4<- lm(abst ~ ., data = complete_data4)



```

```{r}
# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data5 <- complete(imputed_data, 5)

# Complete data model
complete_data5_model5<- lm(abst ~ ., data = complete_data5)


```

```{r}
# Perform multiple imputation
imputed_data <- mice(project2, m = 5, method = 'pmm', maxit = 10, seed = 222)

# Initialize an empty list to store each model
models_list <- list()

# Loop through each imputed dataset
for (i in 1:5) {
  # Get the complete dataset for the ith imputation
  complete_data <- complete(imputed_data, i)
  
  # Fit the linear model on this complete dataset
  models_list[[paste0("model", i)]] <- lm(abst ~ ., data = complete_data)
}

# Check the results
models_list(1)
```

```{r}

# Perform multiple imputation
imputed_data <- mice(project2, m = 5, method = 'pmm', maxit = 10, seed = 222)

# Fit models on each imputed dataset and pool the results
pooled_model <- with(imputed_data, lm(abst ~ .))
pooled_results <- pool(pooled_model)

# Display the pooled summary
summary(pooled_results)


```
```{r}
# Perform multiple imputation
imputed_data <- mice(project2, m = 5, method = 'pmm', maxit = 10, seed = 222)

# Fit the model on each imputed dataset and pool the results
pooled_model <- with(imputed_data, lm(abst ~ id + Var + BA + age_ps + sex_ps + NHW+
                                      Black + Hisp + inc + edu+ ftcd_score + ftcd.5.mins+
                                      bdi_score_w00+ cpd_ps+ crv_total_pq1 + hedonsum_n_pq1+
                                      hedonsum_y_pq1 + shaps_score_pq1+ otherdiag +antidepmed +
                                      mde_curr+ NMR + Only.Menthol + readiness ))
pooled_results <- pool(pooled_model)

# Get a summary of the pooled results
summary_pooled <- summary(pooled_results)

#Make the summary pooled results as our 
pooled_data <- as.data.frame(summary_pooled)

# View or save the data
print(pooled_data)



```




```{r}


# Get a complete dataset from the imputed data (for example, the first imputation)
complete_data2 <- complete(imputed_data, 2)

 #linear model


#pool results
```







```{r}
 #Define Treatment Groups
project2 <- project2 %>%
  mutate(treatment_groups = case_when(
    Var == 1 & BA == 1 ~ "BA_VA",
    Var == 0 & BA == 0 ~ "ST_Placebo",
    Var == 0 & BA == 1 ~ "BA_Placebo",
    Var == 1 & BA == 0 ~ "ST_VA"
  ))

# Create demographic/ baseline characeteristcs tabl

demographics_table <- project2 %>%
  group_by(treatment_groups) %>%
  summarise(
     N= n(),
    `Mean Ages` = round(mean(age_ps, na.rm = TRUE), 1),
    `Standard Deviation Ages` = round(sd(age_ps, na.rm = TRUE), 1),
     Sex = round(sum(as.numeric(as.character(sex_ps)), na.rm = TRUE), 1),
    Blacks = round(sum(as.numeric(as.character(Black)), na.rm = TRUE), 1),
    Hispanics = round(sum(as.numeric(as.character(Hisp)), na.rm = TRUE), 1),
    `Non-Hispanic Whites` = round(sum(as.numeric(as.character(NHW)), na.rm = TRUE), 1),
    `Black Percentage` = round(mean(as.numeric(as.character(Black)), na.rm = TRUE) * 100, 1),
    `Hispanic Percentage` = round(mean(as.numeric(as.character(Hisp)), na.rm = TRUE) * 100, 1),
    `Non-Hispanic White Percentage` = round(mean(as.numeric(as.character(NHW)), na.rm = TRUE) * 100, 1),
    `Education Levels`= c(""),
   `Income Levels`= c("") , 
   `Major Depressive Disorder`= c(""),
    `Antidepressant Medication (%)`=round(mean(as.numeric(as.character(antidepmed)), na.rm = TRUE)*100, 1),
    `Other Lifetime Diagnosis`= round(sum(as.numeric(as.character(otherdiag)), na.rm = TRUE), 1),
    `Cigarette Type`= c(""),
   ` Menthol Only` = round(sum(as.numeric(as.character(Only.Menthol)), na.rm = TRUE), 1),
   `Smoking`= c(""),
   `Cigarettes Per Day at Baseline` = round(mean(as.numeric(as.character(cpd_ps)), na.rm = TRUE), 1),
   `Cigarette Reward Value at Baseline`=round(mean(as.numeric(as.character(crv_total_pq1)), na.rm = TRUE), 1),
    `FTCD at Baseline`=round(mean(as.numeric(as.character(ftcd_score)), na.rm = TRUE), 2),
  `Readiness to Quit`=round(mean(as.numeric(as.character(readiness)), na.rm = TRUE), 1),
  `Time to smoking upon waking up`= c(""),
  `Smoking 5 minutes into waking up (%)`=round(mean(as.numeric(as.character(ftcd.5.mins)), na.rm = TRUE)*100, 1),
  
  `Pleasurable Events at Baseline`= c(""),
  `Substitute Reinforcers`= round(mean(as.numeric(hedonsum_n_pq1), na.rm = TRUE), 1),
  `Complimentary Reinforcers`= round(mean(as.numeric(hedonsum_y_pq1), na.rm = TRUE), 1)
    
  )

education_counts <- project2 %>%
  group_by(treatment_groups, edu) %>%
  summarize(Education_Count = n()) %>%
  pivot_wider(names_from = edu, values_from = Education_Count, values_fill = 0)



inc_counts <- project2 %>%
  group_by(treatment_groups, inc) %>%
  summarize(Income_Count = n()) %>%
  pivot_wider(names_from = inc, values_from = Income_Count, values_fill = 0)



mdd_counts <- project2 %>%
  group_by(treatment_groups, mde_curr) %>%
  summarize(MDE_Count = n()) %>%
  pivot_wider(names_from = mde_curr, values_from = MDE_Count, values_fill = 0)

sex_counts <- project2 %>%
  group_by(treatment_groups, sex_ps) %>%
  summarize(Sex_Count = n()) %>%
  pivot_wider(names_from = sex_ps, values_from = Sex_Count, values_fill = 0)



demographics_table <- demographics_table %>%
  left_join(education_counts, by = "treatment_groups") %>%
  left_join(inc_counts, by = "treatment_groups") %>%
  left_join(mdd_counts, by = "treatment_groups")

demographics_table <- demographics_table %>%
  select(treatment_groups, `N`, `Mean Ages`, `Standard Deviation Ages`, `Sex`,Blacks, Hispanics, `Black Percentage`, `Hispanic Percentage`,`Non-Hispanic Whites`,`Non-Hispanic White Percentage`,`Education Levels`, `1.x`,`2.x`,`3.x`,`4.x`,`5.x`, `Income Levels`, `1.y`,`2.y`,`3.y`,`4.y`,`5.y`,`NA`, `Major Depressive Disorder`, `0`,`1`,
         `Cigarette Type`, ` Menthol Only`,  everything())


  

# Transpose the table
transposed_table <- as.data.frame(t(demographics_table))

# Update column names to reflect the new format
colnames(transposed_table) <- transposed_table[1, ]  # Set the first row as column names
transposed_table <- transposed_table[-1, ]           # Remove the first row (now redundant)
#rownames(transposed_table) <- c("Blacks")            # Rename rows if needed



#Create Kable Extra Table 
#Create Kable Extra Table 
kable(transposed_table, 
      caption = "Demographics Table of the Smoking Cessation Participants",
      col.names = c("Demograhic Characteristics Variable", "BA+Placebo", "BA+VA", "ST+Placebo", "ST+VA"),
      digits =2) # Set digits for p-values and chi-square



```


